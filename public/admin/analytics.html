<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Analytics | Joel Eaton</title>
  <script src="https://accounts.google.com/gsi/client" async></script>
  <style>
    :root {
      --bg-primary: #000814;
      --bg-secondary: #1B2444;
      --card-bg: rgba(27, 36, 68, 0.4);
      --text-primary: #E8EBF7;
      --text-secondary: #8B92A8;
      --accent-primary: #FF3366;
      --accent-secondary: #00E5FF;
      --border-color: rgba(255, 51, 102, 0.1);
      --font-display: 'Fraunces', serif;
      --font-body: 'IBM Plex Sans', sans-serif;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: var(--font-body);
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      -webkit-font-smoothing: antialiased;
    }

    .top-bar {
      background: rgba(0, 8, 20, 0.9);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--border-color);
      padding: 0 1.5rem;
      height: 64px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .top-bar h1 {
      font-family: var(--font-display);
      font-size: 1.25rem;
      font-weight: 700;
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .top-bar-links {
      display: flex;
      gap: 1.5rem;
      align-items: center;
    }

    .top-bar-links a {
      color: var(--text-secondary);
      text-decoration: none;
      font-size: 0.9rem;
      transition: color 0.2s;
    }

    .top-bar-links a:hover { color: var(--text-primary); }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem 1.5rem;
    }

    /* Auth screen */
    .auth-screen {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: calc(100vh - 64px);
      gap: 1.5rem;
      text-align: center;
    }

    .auth-screen h2 {
      font-family: var(--font-display);
      font-size: 2rem;
    }

    .auth-screen p {
      color: var(--text-secondary);
      max-width: 400px;
      line-height: 1.6;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      font-family: var(--font-body);
      font-weight: 600;
      font-size: 0.95rem;
      cursor: pointer;
      border: none;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(255, 51, 102, 0.4);
    }

    .btn-small {
      padding: 0.4rem 0.9rem;
      font-size: 0.8rem;
      border-radius: 6px;
    }

    .btn-outline {
      background: transparent;
      border: 1px solid var(--border-color);
      color: var(--text-secondary);
    }

    .btn-outline:hover {
      border-color: var(--accent-primary);
      color: var(--text-primary);
    }

    /* Dashboard header */
    .dash-header {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .dash-header h2 {
      font-family: var(--font-display);
      font-size: 1.75rem;
    }

    .date-controls {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      flex-wrap: wrap;
    }

    .date-controls input[type="date"] {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      color: var(--text-primary);
      padding: 0.5rem 0.75rem;
      border-radius: 6px;
      font-family: var(--font-body);
      font-size: 0.85rem;
    }

    .date-controls input[type="date"]::-webkit-calendar-picker-indicator {
      filter: invert(0.7);
    }

    .preset-btns {
      display: flex;
      gap: 0.4rem;
    }

    .preset-btn {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      color: var(--text-secondary);
      padding: 0.35rem 0.7rem;
      border-radius: 6px;
      font-size: 0.75rem;
      cursor: pointer;
      transition: all 0.2s;
      font-family: var(--font-body);
    }

    .preset-btn:hover, .preset-btn.active {
      border-color: var(--accent-primary);
      color: var(--text-primary);
      background: rgba(255, 51, 102, 0.1);
    }

    /* Stat cards */
    .stat-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .stat-card {
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 1.25rem;
    }

    .stat-card .label {
      font-size: 0.8rem;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 0.5rem;
    }

    .stat-card .value {
      font-family: var(--font-display);
      font-size: 2rem;
      font-weight: 700;
    }

    /* Tables */
    .data-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    @media (max-width: 768px) {
      .data-grid { grid-template-columns: 1fr; }
    }

    .data-panel {
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      overflow: hidden;
    }

    .data-panel.full-width {
      grid-column: 1 / -1;
    }

    .panel-header {
      padding: 1rem 1.25rem;
      border-bottom: 1px solid var(--border-color);
      font-weight: 600;
      font-size: 0.95rem;
    }

    .data-table {
      width: 100%;
      border-collapse: collapse;
    }

    .data-table th {
      text-align: left;
      padding: 0.6rem 1.25rem;
      font-size: 0.75rem;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      border-bottom: 1px solid var(--border-color);
    }

    .data-table td {
      padding: 0.6rem 1.25rem;
      font-size: 0.9rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.03);
    }

    .data-table tr:last-child td {
      border-bottom: none;
    }

    .data-table .num {
      text-align: right;
      font-variant-numeric: tabular-nums;
      color: var(--accent-secondary);
      font-weight: 600;
    }

    .data-table .bar-cell {
      width: 30%;
    }

    .mini-bar {
      height: 6px;
      border-radius: 3px;
      background: rgba(0, 229, 255, 0.15);
      overflow: hidden;
    }

    .mini-bar-fill {
      height: 100%;
      border-radius: 3px;
      background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
    }

    /* Loading & error */
    .loading {
      text-align: center;
      padding: 3rem;
      color: var(--text-secondary);
    }

    .spinner {
      display: inline-block;
      width: 32px;
      height: 32px;
      border: 3px solid var(--border-color);
      border-top-color: var(--accent-primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-bottom: 1rem;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    .error-msg {
      background: rgba(255, 51, 102, 0.1);
      border: 1px solid rgba(255, 51, 102, 0.3);
      border-radius: 8px;
      padding: 1rem 1.25rem;
      color: var(--accent-primary);
      margin-bottom: 1.5rem;
    }

    .config-notice {
      background: rgba(0, 229, 255, 0.08);
      border: 1px solid rgba(0, 229, 255, 0.2);
      border-radius: 8px;
      padding: 1rem 1.25rem;
      color: var(--accent-secondary);
      margin-bottom: 1.5rem;
      font-size: 0.9rem;
      line-height: 1.6;
    }

    .config-notice code {
      background: rgba(27, 36, 68, 0.6);
      padding: 0.15rem 0.4rem;
      border-radius: 4px;
      font-size: 0.85em;
    }

    /* Google Fonts */
    @import url('https://fonts.googleapis.com/css2?family=Fraunces:wght@600;700;900&family=IBM+Plex+Sans:wght@300;400;500;600;700&display=swap');
  </style>
</head>
<body>

<div class="top-bar">
  <h1>Site Analytics</h1>
  <div class="top-bar-links">
    <a href="/admin/">CMS</a>
    <a href="/">View Site</a>
    <button id="signOutBtn" class="btn btn-small btn-outline" style="display:none;" onclick="handleSignOut()">Sign Out</button>
  </div>
</div>

<!-- Auth screen -->
<div id="authScreen" class="auth-screen">
  <h2>Analytics Dashboard</h2>
  <p>Sign in with Google to view your GA4 analytics data. You must have access to the Google Analytics property.</p>
  <button class="btn btn-primary" onclick="handleSignIn()">Sign in with Google</button>
</div>

<!-- Dashboard -->
<div id="dashboard" class="container" style="display:none;">

  <div class="dash-header">
    <h2>Dashboard</h2>
    <div class="date-controls">
      <div class="preset-btns">
        <button class="preset-btn" data-days="7" onclick="setPreset(7)">7 days</button>
        <button class="preset-btn" data-days="14" onclick="setPreset(14)">14 days</button>
        <button class="preset-btn" data-days="30" onclick="setPreset(30)">30 days</button>
        <button class="preset-btn" data-days="90" onclick="setPreset(90)">90 days</button>
      </div>
      <input type="date" id="startDate" onchange="fetchAll()" />
      <span style="color:var(--text-secondary);">to</span>
      <input type="date" id="endDate" onchange="fetchAll()" />
    </div>
  </div>

  <div id="configNotice" class="config-notice" style="display:none;">
    You need to configure your <code>PROPERTY_ID</code> and <code>CLIENT_ID</code> in this file. See the setup instructions.
  </div>

  <div id="errorBox" class="error-msg" style="display:none;"></div>

  <!-- Summary stats -->
  <div class="stat-grid">
    <div class="stat-card">
      <div class="label">Total Visitors</div>
      <div class="value" id="totalUsers">--</div>
    </div>
    <div class="stat-card">
      <div class="label">Page Views</div>
      <div class="value" id="totalPageviews">--</div>
    </div>
    <div class="stat-card">
      <div class="label">Sessions</div>
      <div class="value" id="totalSessions">--</div>
    </div>
    <div class="stat-card">
      <div class="label">Avg. Session Duration</div>
      <div class="value" id="avgDuration">--</div>
    </div>
  </div>

  <!-- Location + Pages -->
  <div class="data-grid">
    <div class="data-panel">
      <div class="panel-header">Visitors by Country</div>
      <div id="countryTable" class="loading"><div class="spinner"></div><br/>Loading...</div>
    </div>
    <div class="data-panel">
      <div class="panel-header">Visitors by City</div>
      <div id="cityTable" class="loading"><div class="spinner"></div><br/>Loading...</div>
    </div>
  </div>

  <div class="data-grid">
    <div class="data-panel full-width">
      <div class="panel-header">Popular Pages</div>
      <div id="pagesTable" class="loading"><div class="spinner"></div><br/>Loading...</div>
    </div>
  </div>
</div>

<script>
  // ===================================================================
  // CONFIGURATION â€” Replace these with your values (see setup instructions)
  // ===================================================================
  const CONFIG = {
    PROPERTY_ID: '524949582',
    CLIENT_ID: '197541691641-l97pn720rbhc8u6qrjo99f6bftl8ldc0.apps.googleusercontent.com',
  };
  // ===================================================================

  const SCOPES = 'https://www.googleapis.com/auth/analytics.readonly';
  const API_BASE = 'https://analyticsdata.googleapis.com/v1beta';

  let accessToken = null;
  let tokenClient = null;

  // Date helpers
  function formatDate(d) {
    return d.toISOString().split('T')[0];
  }

  function daysAgo(n) {
    const d = new Date();
    d.setDate(d.getDate() - n);
    return d;
  }

  function initDates() {
    const end = new Date();
    const start = daysAgo(7);
    document.getElementById('startDate').value = formatDate(start);
    document.getElementById('endDate').value = formatDate(end);
    highlightPreset(7);
  }

  function setPreset(days) {
    document.getElementById('startDate').value = formatDate(daysAgo(days));
    document.getElementById('endDate').value = formatDate(new Date());
    highlightPreset(days);
    fetchAll();
  }

  function highlightPreset(days) {
    document.querySelectorAll('.preset-btn').forEach(b => {
      b.classList.toggle('active', parseInt(b.dataset.days) === days);
    });
  }

  // Auth
  function handleSignIn() {
    if (CONFIG.CLIENT_ID === 'YOUR_GOOGLE_CLIENT_ID') {
      document.getElementById('configNotice').style.display = 'block';
      document.getElementById('authScreen').style.display = 'none';
      document.getElementById('dashboard').style.display = 'block';
      return;
    }

    if (!tokenClient) {
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CONFIG.CLIENT_ID,
        scope: SCOPES,
        callback: (resp) => {
          if (resp.error) {
            showError('Auth failed: ' + resp.error);
            return;
          }
          accessToken = resp.access_token;
          showDashboard();
        },
      });
    }
    tokenClient.requestAccessToken();
  }

  function handleSignOut() {
    if (accessToken) {
      google.accounts.oauth2.revoke(accessToken);
    }
    accessToken = null;
    document.getElementById('authScreen').style.display = 'flex';
    document.getElementById('dashboard').style.display = 'none';
    document.getElementById('signOutBtn').style.display = 'none';
  }

  function showDashboard() {
    document.getElementById('authScreen').style.display = 'none';
    document.getElementById('dashboard').style.display = 'block';
    document.getElementById('signOutBtn').style.display = 'inline-flex';
    initDates();
    fetchAll();
  }

  function showError(msg) {
    const box = document.getElementById('errorBox');
    box.textContent = msg;
    box.style.display = 'block';
  }

  function clearError() {
    document.getElementById('errorBox').style.display = 'none';
  }

  // GA4 Data API calls
  async function gaReport(body) {
    const url = `${API_BASE}/properties/${CONFIG.PROPERTY_ID}:runReport`;
    const res = await fetch(url, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${accessToken}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(body),
    });

    if (!res.ok) {
      const err = await res.json();
      throw new Error(err.error?.message || `API error ${res.status}`);
    }

    return res.json();
  }

  function getDateRange() {
    return {
      startDate: document.getElementById('startDate').value,
      endDate: document.getElementById('endDate').value,
    };
  }

  // Number formatting
  function fmtNum(n) {
    return Number(n).toLocaleString();
  }

  function fmtDuration(seconds) {
    const s = Math.round(Number(seconds));
    if (s < 60) return s + 's';
    const m = Math.floor(s / 60);
    const rem = s % 60;
    return m + 'm ' + rem + 's';
  }

  // Build table HTML
  function buildTable(headers, rows, maxVal) {
    if (!rows || rows.length === 0) {
      return '<div style="padding:1.5rem;color:var(--text-secondary);text-align:center;">No data for this period</div>';
    }

    let html = '<table class="data-table"><thead><tr>';
    headers.forEach(h => {
      html += `<th${h.align === 'right' ? ' class="num"' : ''}>${h.label}</th>`;
    });
    html += '<th class="bar-cell"></th></tr></thead><tbody>';

    rows.forEach(r => {
      const val = Number(r.metricValues[0].value);
      const pct = maxVal > 0 ? (val / maxVal) * 100 : 0;
      html += '<tr>';
      r.dimensionValues.forEach(d => {
        html += `<td>${d.value === '(not set)' ? '<em style="color:var(--text-secondary)">(not set)</em>' : escapeHtml(d.value)}</td>`;
      });
      html += `<td class="num">${fmtNum(val)}</td>`;
      html += `<td class="bar-cell"><div class="mini-bar"><div class="mini-bar-fill" style="width:${pct}%"></div></div></td>`;
      html += '</tr>';
    });

    html += '</tbody></table>';
    return html;
  }

  function escapeHtml(str) {
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
  }

  // Fetch all data
  async function fetchAll() {
    if (!accessToken) return;
    clearError();

    const range = getDateRange();

    try {
      await Promise.all([
        fetchSummary(range),
        fetchCountry(range),
        fetchCity(range),
        fetchPages(range),
      ]);
    } catch (err) {
      showError(err.message);
    }
  }

  async function fetchSummary(range) {
    const data = await gaReport({
      dateRanges: [range],
      metrics: [
        { name: 'totalUsers' },
        { name: 'screenPageViews' },
        { name: 'sessions' },
        { name: 'averageSessionDuration' },
      ],
    });

    const vals = data.rows?.[0]?.metricValues || [];
    document.getElementById('totalUsers').textContent = vals[0] ? fmtNum(vals[0].value) : '0';
    document.getElementById('totalPageviews').textContent = vals[1] ? fmtNum(vals[1].value) : '0';
    document.getElementById('totalSessions').textContent = vals[2] ? fmtNum(vals[2].value) : '0';
    document.getElementById('avgDuration').textContent = vals[3] ? fmtDuration(vals[3].value) : '0s';
  }

  async function fetchCountry(range) {
    const data = await gaReport({
      dateRanges: [range],
      dimensions: [{ name: 'country' }],
      metrics: [{ name: 'totalUsers' }],
      orderBys: [{ metric: { metricName: 'totalUsers' }, desc: true }],
      limit: 20,
    });

    const rows = data.rows || [];
    const maxVal = rows.length > 0 ? Number(rows[0].metricValues[0].value) : 0;
    document.getElementById('countryTable').innerHTML = buildTable(
      [{ label: 'Country' }, { label: 'Visitors', align: 'right' }],
      rows, maxVal
    );
  }

  async function fetchCity(range) {
    const data = await gaReport({
      dateRanges: [range],
      dimensions: [{ name: 'city' }, { name: 'region' }],
      metrics: [{ name: 'totalUsers' }],
      orderBys: [{ metric: { metricName: 'totalUsers' }, desc: true }],
      limit: 20,
    });

    const rows = data.rows || [];
    const maxVal = rows.length > 0 ? Number(rows[0].metricValues[0].value) : 0;
    document.getElementById('cityTable').innerHTML = buildTable(
      [{ label: 'City' }, { label: 'Region' }, { label: 'Visitors', align: 'right' }],
      rows, maxVal
    );
  }

  async function fetchPages(range) {
    const data = await gaReport({
      dateRanges: [range],
      dimensions: [{ name: 'pagePath' }],
      metrics: [{ name: 'screenPageViews' }],
      orderBys: [{ metric: { metricName: 'screenPageViews' }, desc: true }],
      limit: 30,
    });

    const rows = data.rows || [];
    const maxVal = rows.length > 0 ? Number(rows[0].metricValues[0].value) : 0;
    document.getElementById('pagesTable').innerHTML = buildTable(
      [{ label: 'Page' }, { label: 'Views', align: 'right' }],
      rows, maxVal
    );
  }
</script>

</body>
</html>
